<h1 style="color: #d63384; text-align: center; margin-bottom: 16px;">All Matrimony Profiles</h1>

<!-- Search & Filters -->
<div style="display:flex; flex-direction:column; gap:10px; margin:0 20px 10px; background:#f9f9f9; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
  <!-- Row 1: Search + sort + photo + toggle -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; padding-bottom:10px; border-bottom:1px solid #eee;">
    <input type="text" id="searchInput" placeholder="Search by name, ID or keyword"
           style="padding:10px; flex:1 1 300px; min-width:240px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
    
    <select id="sortSelect" style="padding:10px; min-width:180px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
      <option value="relevance">Sort: Relevance</option>
      <option value="name_asc">Name A–Z</option>
      <option value="name_desc">Name Z–A</option>
      <option value="age_asc">Age Low→High</option>
      <option value="age_desc">Age High→Low</option>
      <option value="height_desc">Height High→Low</option>
      <option value="height_asc">Height Low→High</option>
      <option value="created_desc">Newest First</option>
      <option value="created_asc">Oldest First</option>
    </select>

    <label style="display:flex; align-items:center; gap:6px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#fff; font-size:14px; cursor:pointer;">
      <input type="checkbox" id="hasPhoto" style="cursor:pointer;"> With Photo Only
    </label>

    <label style="display:flex; align-items:center; gap:6px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#fff; font-size:14px; cursor:pointer;">
      <input type="checkbox" id="premiumOnly" style="cursor:pointer;"> Premium Profiles
    </label>

    <button id="toggleMoreFilters" style="padding:10px 15px; background:#f0f0f0; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:5px;">
      <span>More Filters</span>
      <span id="toggleIcon">▾</span>
    </button>

    <button id="resetBtn" style="padding:10px 15px; background:#fff; color:#d63384; border:1px solid #d63384; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;">
      Reset All
    </button>
  </div>

  <!-- Mandatory Filters Row -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; padding:10px 0; border-bottom:1px solid #eee;">
    <div style="flex:1; min-width:180px;">
      <select id="filter_gender" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
        <option value="">Gender: Any</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <div style="flex:1; min-width:180px;">
      <select id="filter_maritalStatus" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
        <option value="">Marital Status: Any</option>
        <option value="Never Married">Never Married</option>
        <option value="Divorced">Divorced</option>
        <option value="Widowed">Widowed</option>
        <option value="Separated">Separated</option>
      </select>
    </div>
    
    <div style="flex:1; min-width:180px;">
      <select id="filter_religion" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
        <option value="">Religion: Any</option>
        <!-- Will be populated dynamically -->
      </select>
    </div>
    
    <div style="flex:1; min-width:180px;">
      <select id="filter_caste" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
        <option value="">Caste: Any</option>
        <!-- Will be populated dynamically -->
      </select>
    </div>
  </div>

  <!-- Age/Height Row -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; padding:10px 0; border-bottom:1px solid #eee;">
    <div style="flex:1; min-width:200px; display:flex; gap:8px; align-items:center; border:1px solid #ddd; border-radius:8px; padding:8px 12px; background:#fff;">
      <span style="font-size:14px; color:#555; white-space:nowrap;">Age Range</span>
      <input type="number" id="ageMin" placeholder="Min" min="18" max="99" style="width:60px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:14px;">
      <span style="color:#aaa;">to</span>
      <input type="number" id="ageMax" placeholder="Max" min="18" max="99" style="width:60px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:14px;">
    </div>

    <div style="flex:1; min-width:200px; display:flex; gap:8px; align-items:center; border:1px solid #ddd; border-radius:8px; padding:8px 12px; background:#fff;">
      <span style="font-size:14px; color:#555; white-space:nowrap;">Height Range</span>
      <input type="number" id="heightMin" placeholder="Min" min="100" max="250" style="width:60px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:14px;">
      <span style="color:#aaa;">to</span>
      <input type="number" id="heightMax" placeholder="Max" min="100" max="250" style="width:60px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:14px;">
      <span style="font-size:14px; color:#555;">cm</span>
    </div>
    
    <div style="flex:1; min-width:200px; display:flex; gap:8px; align-items:center; border:1px solid #ddd; border-radius:8px; padding:8px 12px; background:#fff;">
      <span style="font-size:14px; color:#555; white-space:nowrap;">Income (LPA)</span>
      <input type="number" id="incomeMin" placeholder="Min" min="0" max="100" style="width:60px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:14px;">
      <span style="color:#aaa;">to</span>
      <input type="number" id="incomeMax" placeholder="Max" min="0" max="100" style="width:60px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:14px;">
    </div>
  </div>

  <!-- Dynamic filters grid (auto-filled from data) -->
  <div id="moreFilters" style="display:none;">
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px; margin-top:10px; padding:10px 0; border-top:1px solid #eee;">
      <!-- Education -->
      <div>
        <select id="filter_education" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Education: Any</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <!-- Profession -->
      <div>
        <select id="filter_profession" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Profession: Any</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <!-- Country -->
      <div>
        <select id="filter_country" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Country: Any</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <!-- State -->
      <div>
        <select id="filter_state" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">State: Any</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <!-- City -->
      <div>
        <select id="filter_city" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">City: Any</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <!-- Mother Tongue -->
      <div>
        <select id="filter_motherTongue" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Mother Tongue: Any</option>
          
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <!-- Manglik -->
      <div>
        <select id="filter_manglik" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Manglik: Any</option>
          <option value="Yes">Manglik</option>
          <option value="No">Non-Manglik</option>
          <option value="Partial">Partial Manglik</option>
        </select>
      </div>
      
      <!-- Diet -->
      <div>
        <select id="filter_diet" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Diet: Any</option>
          <option value="Vegetarian">Vegetarian</option>
          <option value="Non-Vegetarian">Non-Vegetarian</option>
          <option value="Eggetarian">Eggetarian</option>
          <option value="Vegan">Vegan</option>
        </select>
      </div>
      
      
      <!-- Disability -->
      <div>
        <select id="filter_disability" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;">
          <option value="">Disability: Any</option>
          <option value="None">No Disability</option>
          <option value="Physical">Physical Disability</option>
          <option value="Hearing">Hearing Impaired</option>
          <option value="Vision">Vision Impaired</option>
          <option value="Other">Other Disability</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Results meta -->
  <div id="resultsMeta" style="text-align:center; font-size:14px; color:#666; padding:10px 0; font-weight:500;">Loading profiles...</div>
</div>

<!-- Profiles Container -->
<div id="profiles-container" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:25px; padding:20px;"></div>

<!-- Success Notification -->
<div id="successNotification" style="display:none; position:fixed; bottom:20px; right:20px; background:#4CAF50; color:white; padding:15px 25px; border-radius:5px; box-shadow:0 3px 10px rgba(0,0,0,0.2); z-index:1000;">
  Connection request sent successfully!
</div>

<script>
// ===== Utils =====
const norm = (v) => String(v ?? '').trim().toLowerCase();
const nonEmpty = (v) => v !== undefined && v !== null && String(v).trim() !== '';
const uniqueValues = (arr, key) => {
  const set = new Set();
  arr.forEach(p => { if (nonEmpty(p[key])) set.add(String(p[key]).trim()); });
  return Array.from(set).sort((a,b) => a.localeCompare(b));
};

function toNumber(val) {
  if (val === undefined || val === null) return null;
  const n = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
  return Number.isFinite(n) ? n : null;
}

function getHeight(profile) {
  return toNumber(profile.height);
}

function getAge(profile) {
  // Try direct numeric age
  if (Number.isFinite(profile.age)) return profile.age;
  const maybe = toNumber(profile.age);
  if (maybe !== null) return maybe;
  // Try DOB-style fields
  const dobKey = ['dob','dateOfBirth','birthDate','DoB','DOB'].find(k => nonEmpty(profile[k]));
  if (dobKey) {
    const d = new Date(profile[dobKey]);
    if (!isNaN(d)) {
      const diff = Date.now() - d.getTime();
      const age = Math.floor(diff / (365.25*24*60*60*1000));
      if (Number.isFinite(age)) return age;
    }
  }
  return null;
}

function getIncome(profile) {
  if (Number.isFinite(profile.annualIncome)) return profile.annualIncome;
  const maybe = toNumber(profile.income || profile.annualIncome);
  if (maybe !== null) return maybe;
  return null;
}

function hasPhotoFn(profile) {
  const p = String(profile.profilePhoto || '').trim();
  return p && p.toLowerCase() !== 'default.jpg';
}

function isPremium(profile) {
  return profile.premium === true || norm(profile.membershipType) === 'premium';
}

// ===== Global state =====
let allProfiles = [];
let pendingConnections = {}; // Track pending connections
let dynamicFilterFields = ['gender', 'maritalStatus', 'religion', 'caste', 'education', 'profession', 
                          'country', 'state', 'city', 'motherTongue', 'manglik', 'diet', 'disability'];

// ===== Fetch & init =====
async function fetchProfiles() {
  try {
    document.getElementById('resultsMeta').textContent = 'Loading profiles...';
    const res = await fetch('http://localhost:5000/api/create_profile');
    const profiles = await res.json();
    allProfiles = Array.isArray(profiles) ? profiles : [];
    initializeFilters();
    applyFilters();
  } catch (err) {
    console.error('Error fetching profiles:', err);
    document.getElementById('profiles-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading profiles. Please try again later.</p>';
    document.getElementById('resultsMeta').textContent = '';
  }
}

function initializeFilters() {
  // Initialize religion dropdown
  const religions = uniqueValues(allProfiles, 'religion');
  const religionSelect = document.getElementById('filter_religion');
  religionSelect.innerHTML = '<option value="">Religion: Any</option>' + 
    religions.map(r => `<option value="${r}">${r}</option>`).join('');
  
  // Initialize caste dropdown
  const castes = uniqueValues(allProfiles, 'caste');
  const casteSelect = document.getElementById('filter_caste');
  casteSelect.innerHTML = '<option value="">Caste: Any</option>' + 
    castes.map(c => `<option value="${c}">${c}</option>`).join('');
  
  // Initialize education dropdown
  const educations = uniqueValues(allProfiles, 'education');
  const educationSelect = document.getElementById('filter_education');
  educationSelect.innerHTML = '<option value="">Education: Any</option>' + 
    educations.map(e => `<option value="${e}">${e}</option>`).join('');
  
  // Initialize profession dropdown
  const professions = uniqueValues(allProfiles, 'profession') || uniqueValues(allProfiles, 'occupation');
  const professionSelect = document.getElementById('filter_profession');
  professionSelect.innerHTML = '<option value="">Profession: Any</option>' + 
    professions.map(p => `<option value="${p}">${p}</option>`).join('');
  
  // Initialize country dropdown
  const countries = uniqueValues(allProfiles, 'country');
  const countrySelect = document.getElementById('filter_country');
  countrySelect.innerHTML = '<option value="">Country: Any</option>' + 
    countries.map(c => `<option value="${c}">${c}</option>`).join('');
  
  // Initialize state dropdown
  const states = uniqueValues(allProfiles, 'state');
  const stateSelect = document.getElementById('filter_state');
  stateSelect.innerHTML = '<option value="">State: Any</option>' + 
    states.map(s => `<option value="${s}">${s}</option>`).join('');
  
  // Initialize city dropdown
  const cities = uniqueValues(allProfiles, 'city');
  const citySelect = document.getElementById('filter_city');
  citySelect.innerHTML = '<option value="">City: Any</option>' + 
    cities.map(c => `<option value="${c}">${c}</option>`).join('');
  
  // Initialize mother tongue dropdown
  const motherTongues = uniqueValues(allProfiles, 'motherTongue');
  const motherTongueSelect = document.getElementById('filter_motherTongue');
  motherTongueSelect.innerHTML = '<option value="">Mother Tongue: Any</option>' + 
    motherTongues.map(m => `<option value="${m}">${m}</option>`).join('');
  
  // Add event listeners to all filter controls
  dynamicFilterFields.forEach(key => {
    const el = document.getElementById(`filter_${key}`);
    if (el) el.addEventListener('change', applyFilters);
  });
  
  document.getElementById('resultsMeta').textContent = `Ready to search ${allProfiles.length} profiles`;
}

// ===== Filtering & sorting =====
function applyFilters() {
  const q = norm(document.getElementById('searchInput').value);
  const hasPhoto = document.getElementById('hasPhoto').checked;
  const premiumOnly = document.getElementById('premiumOnly').checked;
  const ageMin = toNumber(document.getElementById('ageMin').value);
  const ageMax = toNumber(document.getElementById('ageMax').value);
  const hMin = toNumber(document.getElementById('heightMin').value);
  const hMax = toNumber(document.getElementById('heightMax').value);
  const incomeMin = toNumber(document.getElementById('incomeMin').value);
  const incomeMax = toNumber(document.getElementById('incomeMax').value);

  // Gather all filter selections
  const filters = {};
  dynamicFilterFields.forEach(key => {
    const el = document.getElementById(`filter_${key}`);
    filters[key] = el ? norm(el.value) : '';
  });

  const tokens = q.split(/ +/).filter(Boolean);

  let results = allProfiles.filter(p => {
    // Name/ID search
    const fullName = norm(`${p.firstName || ''} ${p.lastName || ''}`);
    const profileId = norm(p.profileId || p.id || '');
    const matchesSearch = tokens.length ? 
      (tokens.every(t => fullName.includes(t)) || tokens.every(t => profileId.includes(t))) : true;

    // Filter matches
    const matchesFilters = dynamicFilterFields.every(key => {
      const wanted = filters[key];
      if (!wanted) return true; // not selected = pass
      return norm(p[key]) === wanted;
    });

    // Photo filter
    const matchesPhoto = hasPhoto ? hasPhotoFn(p) : true;
    
    // Premium filter
    const matchesPremium = premiumOnly ? isPremium(p) : true;

    // Age range
    const age = getAge(p);
    const matchesAge = (
      (ageMin === null || (age !== null && age >= ageMin)) &&
      (ageMax === null || (age !== null && age <= ageMax))
    );

    // Height range
    const ht = getHeight(p);
    const matchesHeight = (
      (hMin === null || (ht !== null && ht >= hMin)) &&
      (hMax === null || (ht !== null && ht <= hMax))
    );
    
    // Income range
    const income = getIncome(p);
    const matchesIncome = (
      (incomeMin === null || (income !== null && income >= incomeMin)) &&
      (incomeMax === null || (income !== null && income <= incomeMax))
    );

    return matchesSearch && matchesFilters && matchesPhoto && matchesPremium && 
           matchesAge && matchesHeight && matchesIncome;
  });

  // Sorting
  const sortBy = document.getElementById('sortSelect').value;
  results = results.slice();
  
  if (sortBy === 'name_asc') {
    results.sort((a,b) => norm(a.lastName || '').localeCompare(norm(b.lastName || '')) || 
                         norm(a.firstName || '').localeCompare(norm(b.firstName || '')));
  } else if (sortBy === 'name_desc') {
    results.sort((a,b) => norm(b.lastName || '').localeCompare(norm(a.lastName || '')) || 
                         norm(b.firstName || '').localeCompare(norm(a.firstName || '')));
  } else if (sortBy === 'age_asc') {
    results.sort((a,b) => (getAge(a) ?? Infinity) - (getAge(b) ?? Infinity));
  } else if (sortBy === 'age_desc') {
    results.sort((a,b) => (getAge(b) ?? -Infinity) - (getAge(a) ?? -Infinity));
  } else if (sortBy === 'height_desc') {
    results.sort((a,b) => (getHeight(b) ?? -Infinity) - (getHeight(a) ?? -Infinity));
  } else if (sortBy === 'height_asc') {
    results.sort((a,b) => (getHeight(a) ?? Infinity) - (getHeight(b) ?? Infinity));
  } else if (sortBy === 'created_desc') {
    results.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
  } else if (sortBy === 'created_asc') {
    results.sort((a,b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
  } // relevance = keep natural order

  renderProfiles(results);

  const meta = document.getElementById('resultsMeta');
  meta.textContent = results.length === allProfiles.length ? 
    `Showing all ${results.length} profiles` :
    `Showing ${results.length} of ${allProfiles.length} profiles (filtered)`;
}

function renderProfiles(profiles) {
  const container = document.getElementById('profiles-container');
  container.innerHTML = '';

  if (!profiles.length) {
    container.innerHTML = `
      <div style="grid-column:1/-1; text-align:center; padding:40px 20px;">
        <p style="font-size:16px; color:#666; margin-bottom:20px;">No profiles match your search criteria.</p>
        <button onclick="resetFilters()" style="padding:10px 20px; background:#d63384; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">
          Reset Filters
        </button>
      </div>
    `;
    return;
  }

  profiles.forEach(profile => {
    const card = document.createElement('div');
    card.setAttribute('style', `
      background:#fff; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.08); 
      overflow:hidden; display:flex; flex-direction:column; transition:transform 0.2s;
      border:1px solid #eee; position:relative;
    `);
    card.onmouseover = () => card.style.transform = 'translateY(-5px)';
    card.onmouseout = () => card.style.transform = 'none';

    const profileId = profile.id; // Changed from profile.profileId to profile.id
    const isPending = pendingConnections[profileId];
    
    const photoSrc = `/uploads/${(profile.profilePhoto || 'default.jpg')}`;
    const isPremiumProfile = isPremium(profile);
    const age = getAge(profile);
    const height = getHeight(profile);
    const income = getIncome(profile);
    
    card.innerHTML = `
      ${isPremiumProfile ? `<div style="position:absolute; top:10px; left:10px; background:gold; color:#333; padding:3px 8px; border-radius:4px; font-size:12px; font-weight:bold; z-index:1;">PREMIUM</div>` : ''}
      <div style="width:100%; height:220px; overflow:hidden; position:relative; background:#f5f5f5;">
        <img src="${photoSrc}" alt="Profile Photo" style="width:100%; height:100%; object-fit:cover; transition:transform 0.3s;">
        <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.5)); padding:10px; color:white;">
          <h3 style="margin:0; font-size:18px; font-weight:600;">${profile.firstName || ''} ${profile.lastName || ''}</h3>
          <div style="display:flex; gap:15px; font-size:14px; margin-top:5px;">
            ${age ? `<span>${age} yrs</span>` : ''}
            ${height ? `<span>${height} cm</span>` : ''}
            ${profile.city ? `<span>${profile.city}</span>` : ''}
          </div>
        </div>
      </div>
      <div style="padding:15px; flex:1; display:flex; flex-direction:column;">
        <div style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:5px;">
          ${profile.religion ? `<span style='padding:4px 8px; background:#f3f3f3; border-radius:4px; font-size:12px;'>${profile.religion}</span>` : ''}
          ${profile.caste ? `<span style='padding:4px 8px; background:#f3f3f3; border-radius:4px; font-size:12px;'>${profile.caste}</span>` : ''}
          ${profile.maritalStatus ? `<span style='padding:4px 8px; background:#f3f3f3; border-radius:4px; font-size:12px;'>${profile.maritalStatus}</span>` : ''}
        </div>
        
        <div style="margin-bottom:10px;">
          ${profile.education ? `<div style="font-size:13px; color:#555; margin-bottom:5px;"><strong>Education:</strong> ${profile.education}</div>` : ''}
          ${profile.profession || profile.occupation ? `<div style="font-size:13px; color:#555; margin-bottom:5px;"><strong>Profession:</strong> ${profile.profession || profile.occupation}</div>` : ''}
          ${income ? `<div style="font-size:13px; color:#555;"><strong>Income:</strong> ₹${income} LPA</div>` : ''}
        </div>
        
        <div style="margin-top:auto; display:flex; gap:10px; padding-top:10px;">
          <button style="flex:1; padding:10px; border:1px solid #d63384; background:white; color:#d63384; border-radius:6px; cursor:pointer; font-size:14px; font-weight:500;">View Profile</button>
          ${isPending ? 
            `<button style="flex:1; padding:10px; border:none; background:#f0f0f0; color:#666; border-radius:6px; font-size:14px; font-weight:500; cursor:default;">
              <span style="display:inline-flex; align-items:center; gap:5px;">
                <span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#FFA500;"></span>
                Pending
              </span>
            </button>` : 
            `<button onclick="sendConnectionRequest('${profileId}')" style="flex:1; padding:10px; border:none; background:#d63384; color:white; border-radius:6px; cursor:pointer; font-size:14px; font-weight:500;">Connect</button>`
          }
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// ===== Connection Request Functionality =====
async function sendConnectionRequest(profileId) {
  try {
    // In a real application, you would send this request to your backend
    const response = await fetch('http://localhost:5000/api/connect', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        profileId: profileId,
        senderName: 'Interested User', // You can customize this
        senderEmail: 'user@example.com', // You can customize this
        senderPhone: '1234567890' // You can customize this
      })
    });

    if (!response.ok) {
      throw new Error('Failed to send connection request');
    }

    // Mark as pending in UI
    pendingConnections[profileId] = true;
    
    // Show success notification
    showSuccessNotification();
    
    // Re-render profiles to update the pending status
    applyFilters();
  } catch (error) {
    console.error('Error sending connection request:', error);
    alert('Failed to send connection request. Please try again.');
  }
}

function showSuccessNotification() {
  const notification = document.getElementById('successNotification');
  notification.style.display = 'block';
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

// ===== Events & helpers =====
function debounce(fn, delay=300) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null,args), delay); };
}

const debouncedApply = debounce(applyFilters, 250);

document.getElementById('searchInput').addEventListener('input', debouncedApply);
['ageMin','ageMax','heightMin','heightMax','incomeMin','incomeMax'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('input', debouncedApply);
});

document.getElementById('hasPhoto').addEventListener('change', applyFilters);
document.getElementById('premiumOnly').addEventListener('change', applyFilters);
document.getElementById('sortSelect').addEventListener('change', applyFilters);

// Toggle more filters
const moreBtn = document.getElementById('toggleMoreFilters');
const moreWrap = document.getElementById('moreFilters');
const toggleIcon = document.getElementById('toggleIcon');
moreBtn.addEventListener('click', () => {
  const open = moreWrap.style.display !== 'none';
  moreWrap.style.display = open ? 'none' : 'block';
  toggleIcon.textContent = open ? '▾' : '▴';
});

// Reset all filters
function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('hasPhoto').checked = false;
  document.getElementById('premiumOnly').checked = false;
  document.getElementById('sortSelect').value = 'relevance';
  
  // Reset range inputs
  ['ageMin','ageMax','heightMin','heightMax','incomeMin','incomeMax'].forEach(id => {
    document.getElementById(id).value = '';
  });
  
  // Reset all select dropdowns
  dynamicFilterFields.forEach(key => {
    const el = document.getElementById(`filter_${key}`);
    if (el) el.value = '';
  });
  
  // Close more filters if open
  moreWrap.style.display = 'none';
  toggleIcon.textContent = '▾';
  
  applyFilters();
}

document.getElementById('resetBtn').addEventListener('click', resetFilters);

// Fetch on load
document.addEventListener('DOMContentLoaded', fetchProfiles);
</script>